---
Title: 'One-way ANOVA'
Section: 'One-way ANOVA'
Author: "Adam Dede"
Course: "Data to Decisions: Master Statistics with R and tidyverse"
Course_URL: "https://www.udemy.com/course/statsr_ad" 
output:
  html_document:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: console
---


## Set environment

```{r message = FALSE, warning = FALSE}

# Set rendering parameters
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

gitHubPath <- file.path(path.expand("~"), "GitHub", 
                        "MasterStatsUsingR")


library(tidyverse) # data manipulation and visualization
source(file.path(gitHubPath, 'courseTheme.R'))

```

## advertising data
#https://www.kaggle.com/datasets/chebotinaa/fast-food-marketing-campaign-ab-test

```{r data}
df <- read.csv(file.path(gitHubPath, 'data', 
                         'WA_Marketing-Campaign.csv'))
df$Promotion <- as.factor(df$Promotion)
```

## But wait! sample size seems too high! REPEAT FROM AB TESTING UNIT 

```{r sample size}

length(unique(df$LocationID))

names(df)


df<- df %>% group_by(LocationID) %>%
  summarize(SalesInThousands = mean(SalesInThousands),
    across(everything(), ~ first(.), .names = "{.col}"))

#After averaging over weeks, variability is lower: 
df %>% ggplot(aes(y = SalesInThousands, color = Promotion)) + 
    geom_boxplot(linewidth = 2)+ 
  myTheme + brightCol + brightFil+
        theme(axis.text.x = element_blank())



```

## Do an ANOVA by hand to test for a difference between promotions

```{r anova}
# Step 1: Do sales vary with different promotions? 
# Step 2: Null: Sales are the same across promotions
#         Alternative: Sales differ across promotions

# Step 3: Degrees of freedom and F critical value
k = length(unique(df$Promotion))  # number of groups
N = dim(df)[1]
dfbetween = k - 1
dfwithin = N - k
Fcrit = qf(.95, df1 = dfbetween, df2 = dfwithin)

# Step 4: Calculate F ratio for the ANOVA
#F = MSbetween / MSwithin 
#MSbetween = SSbetween / dfbetween

# SSbetween: sum(ni * (group mean - grand mean)^2)
GM = mean(df$SalesInThousands)
SSbetween = 0
for(p in unique(df$Promotion)){
  tmp = df %>% filter(Promotion == p)
  SSbetween = SSbetween + 
    dim(tmp)[1] * (mean(tmp$SalesInThousands) - GM)^2
}
MSbetween = SSbetween / dfbetween

# SSwithin: sum((x - group mean)^2)
SSwithin = 0
for(p in unique(df$Promotion)){
  tmp = df %>% filter(Promotion == p)
  SSwithin = SSwithin + sum((tmp$SalesInThousands - mean(tmp$SalesInThousands))^2)
}
MSwithin = SSwithin / dfwithin

# F ratio
Fratio = MSbetween / MSwithin

# Step 5: convert to p-value, is it significant? 
pval = 1 - pf(Fratio, dfbetween, dfwithin)

# Step 6: Interpretation
if(Fratio > Fcrit){
  cat("The observed F ratio of", round(Fratio, 2),
      "is greater than F critical of", round(Fcrit, 2),
      ".\nStores with different promotions differ in sales.\n")
} else {
  cat("The observed F ratio of", round(Fratio, 2),
      "is NOT greater than F critical of", round(Fcrit, 2),
      ".\nNo evidence stores with different promotions differ in sales.\n")
}

# Built-in comparison
anova(lm(SalesInThousands ~ Promotion, data = df))



```


